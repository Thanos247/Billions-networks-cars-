<!doctype html>

<html lang="en">
<head>
<meta charset="utf-8">
<title>FRIENDLY BILLION CARS</title>
<style>
html,body { margin:0; height:100%; overflow:hidden; background:#111; }
canvas { display:block; }
#score { position:fixed; top:10px; left:10px; color:#fff; font-family:sans-serif; font-size:20px; background:rgba(0,0,0,0.5); padding:6px 12px; border-radius:6px;}
#title { position:fixed; top:10px; right:10px; color:#fff; font-family:sans-serif; font-size:16px; background:rgba(0,0,0,0.5); padding:4px 8px; border-radius:4px; z-index:1000;}
#startBtn, #restartBtn {
  position: fixed; top:50%; left:50%; transform:translate(-50%,-50%);
  padding:12px 24px; font-size:20px; border:none; border-radius:8px; cursor:pointer; color:#fff;
}
#startBtn { background:#28a745; }
#restartBtn { background:#dc3545; display:none; }
</style>
</head>
<body>
<div id="score">gBillion: 0</div>
<div id="title">FRIENDLY BILLION CARS</div>
<button id="startBtn">START GAME</button>
<button id="restartBtn">RESTART</button>

<!-- Audio element for background music -->

<audio id="backgroundMusic" loop>
  <source src="https://s31.aconvert.com/convert/p3r68-cdx67/w5ppp-kfcrv.mp3" type="audio/mpeg">
  Your browser does not support the audio element.
</audio>

<script type="module">
import * as THREE from 'https://unpkg.com/three@0.152.2/build/three.module.js';

let scene = new THREE.Scene();
scene.background = new THREE.Color(0xaaddee); // Lighter sky blue for a friendly feel

let camera = new THREE.PerspectiveCamera(60, window.innerWidth/window.innerHeight, 0.1, 1000);
camera.position.set(0,8,15); // Increased Y and Z for a higher, further back view

let renderer = new THREE.WebGLRenderer({antialias:true});
renderer.setSize(window.innerWidth, window.innerHeight);
document.body.appendChild(renderer.domElement);

// lights
scene.add(new THREE.HemisphereLight(0xffffff, 0x444444, 1));
let dir = new THREE.DirectionalLight(0xffffff, 0.8);
dir.position.set(-10,20,-10);
scene.add(dir);

// road & grass
let road = new THREE.Mesh(new THREE.PlaneGeometry(20,2000), new THREE.MeshStandardMaterial({color:0x444444})); // Slightly lighter road
road.rotation.x=-Math.PI/2; scene.add(road);
let grass = new THREE.Mesh(new THREE.PlaneGeometry(200,2000), new THREE.MeshStandardMaterial({color:0x6B8E23})); // A bit brighter green
grass.rotation.x=-Math.PI/2; grass.position.y=-0.01; scene.add(grass);

// stripes
let stripes=[];
for(let z=0; z<2000; z+=10){
  let s=new THREE.Mesh(new THREE.PlaneGeometry(0.5,4), new THREE.MeshStandardMaterial({color:0xffffee}));
  s.rotation.x=-Math.PI/2; s.position.set(0,0.01,-z);
  scene.add(s); stripes.push(s);
}

// trees
let trees=[];
function makeTree(x,z){
  let trunk=new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,2), new THREE.MeshStandardMaterial({color:0x8B4513}));
  trunk.position.set(x,1,-z);
  let leaves=new THREE.Mesh(new THREE.SphereGeometry(1.5,8,8), new THREE.MeshStandardMaterial({color:0x32CD32})); // Brighter leaves
  leaves.position.set(x,3,-z);
  scene.add(trunk); scene.add(leaves); trees.push(trunk,leaves);
}
for(let z=0; z<2000; z+=15){
  makeTree(-12+Math.random()*2,z+Math.random()*5);
  makeTree(12+Math.random()*2,z+Math.random()*5);
}

// 3D Player Car (More realistic)
let car = new THREE.Group();

// Body
let body = new THREE.Mesh(new THREE.BoxGeometry(2,0.5,4), new THREE.MeshStandardMaterial({color:0x0077ff})); // Changed to a slightly lighter blue
body.position.y=0.5; car.add(body);

// Hood/top curve
let hood = new THREE.Mesh(new THREE.BoxGeometry(2,0.2,1.5), new THREE.MeshStandardMaterial({color:0x66aaff})); // Changed to a lighter blue
hood.position.set(0,0.6,0.8); car.add(hood);

// Cabin (glass)
let cabin = new THREE.Mesh(new THREE.BoxGeometry(1.5,0.4,2), new THREE.MeshStandardMaterial({color:0x00ccff, transparent:true, opacity:0.6}));
cabin.position.set(0,0.8,0); car.add(cabin);

// Wheels with rims
let wheelMat = new THREE.MeshStandardMaterial({color:0x111111});
let rimMat = new THREE.MeshStandardMaterial({color:0x777777}); // Lighter rims
let positions = [[-0.8,0.25,-1.3],[0.8,0.25,-1.3],[-0.8,0.25,1.3],[0.8,0.25,1.3]];
positions.forEach(p=>{
  let wheel = new THREE.Mesh(new THREE.CylinderGeometry(0.3,0.3,0.2,16), wheelMat);
  wheel.rotation.z=Math.PI/2; wheel.position.set(p[0],p[1],p[2]);
  let rim = new THREE.Mesh(new THREE.CylinderGeometry(0.15,0.15,0.21,16), rimMat);
  rim.rotation.z=Math.PI/2; wheel.add(rim);
  car.add(wheel);
});

// Headlights
let headL = new THREE.Mesh(new THREE.SphereGeometry(0.1,8,8), new THREE.MeshStandardMaterial({color:0xffffaa}));
headL.position.set(-0.6,0.35,-2);
let headR = headL.clone(); headR.position.set(0.6,0.35,-2);
car.add(headL); car.add(headR);

// Taillights
let tailL = new THREE.Mesh(new THREE.SphereGeometry(0.1,8,8), new THREE.MeshStandardMaterial({color:0xff0000}));
tailL.position.set(-0.6,0.35,2);
let tailR = tailL.clone(); tailR.position.set(0.6,0.35,2);
car.add(tailL); car.add(tailR);

car.position.set(0,0,0); scene.add(car);

// Enemy cars & coins
let enemies = [], coins = [];
let coinMaterials = []; // Array to hold loaded coin textures

// List of your image URLs
const coinImageUrls = [
  "https://i.imgur.com/AXh5s7l.jpeg", "https://i.imgur.com/sA37U7S.jpeg", "https://i.imgur.com/uag2Vn8.jpeg",
  "https://i.imgur.com/IYuLWkT.jpeg", "https://i.imgur.com/k6zHNNS.jpeg", "https://i.imgur.com/tK3OMx0.jpeg",
  "https://i.imgur.com/9mJ4xcf.jpeg", "https://i.imgur.com/NOC3OZS.jpeg", "https://i.imgur.com/3dtZUTs.jpeg",
  "https://i.imgur.com/qr6D5jp.jpeg", "https://i.imgur.com/0iULwh3.jpeg", "https://i.imgur.com/k6zHNNS.jpeg",
  "https://i.imgur.com/li0rpju.jpeg", "https://i.imgur.com/cxl0n1C.jpeg", "https://i.imgur.com/NF4I6Gu.jpeg",
  "https://i.imgur.com/zEa3N3J.jpeg", "https://i.imgur.com/za88qxB.jpeg", "https://i.imgur.com/U34mM3E.jpeg",
  "https://i.imgur.com/SQ9EkFn.jpeg", "https://i.imgur.com/jjS0GGH.jpeg", "https://i.imgur.com/9ShFitr.jpeg",
  "https://i.imgur.com/DubdIRu.jpeg", "https://i.imgur.com/bmXibxH.jpeg", "https://i.imgur.com/OJQSD3n.jpeg",
  "https://i.imgur.com/5VNadWQ.jpeg", "https://i.imgur.com/KNisQT6.jpeg", "https://i.imgur.com/156jQe7.jpeg",
  "https://i.imgur.com/dOC4zC8.jpeg", "https://i.imgur.com/amV4ki4.jpeg", "https://i.imgur.com/zb6kUtP.jpeg",
  "https://i.imgur.com/hbBgCac.jpeg", "https://i.imgur.com/8poJDU5.jpeg", "https://i.imgur.com/XnmlN10.jpeg",
  "https://i.imgur.com/wAChEPf.jpeg", "https://i.imgur.com/cduV8LZ.jpeg", "https://i.imgur.com/k4BMwcv.jpeg",
  "https://i.imgur.com/iwxFBjs.jpeg", "https://i.imgur.com/dIfZKGS.jpeg", "https://i.imgur.com/zpNaQ7j.jpeg",
  "https://i.imgur.com/XiLcWxD.jpeg", "https://i.imgur.com/1UimMkA.jpeg", "https://i.imgur.com/VAp4L6r.jpeg",
  "https://i.imgur.com/qt2D5oY.jpeg", "https://i.imgur.com/trWRMFW.jpeg", "https://i.imgur.com/gQhW6Jh.jpeg",
  "https://i.imgur.com/TwPPDr1.jpeg", "https://i.imgur.com/LLb4Qtj.jpeg", "https://i.imgur.com/QjR3hA7.jpeg",
  "https://i.imgur.com/n1iHkqF.jpeg", "https://i.imgur.com/yIU62RE.jpeg", "https://i.imgur.com/s8Fr6Eq.jpeg",
  "https://i.imgur.com/CVZINgA.jpeg", "https://i.imgur.com/Wy1C6eF.jpeg", "https://i.imgur.com/dvNDJMB.jpeg",
  "https://i.imgur.com/fF10Kkc.jpeg", "https://i.imgur.com/xR0SpOF.jpeg", "https://i.imgur.com/eoySasT.jpeg",
  "https://i.imgur.com/KlLMxEU.jpeg", "https://i.imgur.com/ON8zkcG.jpeg", "https://i.imgur.com/t9gLY7x.jpeg",
  "https://i.imgur.com/bq2zQst.jpeg", "https://i.imgur.com/dfSPzi8.jpeg", "https://i.imgur.com/P6z4FHi.jpeg",
  "https://i.imgur.com/BiZkRqV.jpeg", "https://i.imgur.com/DjE1X0N.jpeg", "https://i.imgur.com/xDBH6JU.jpeg",
  "https://i.imgur.com/9p2QLFi.jpeg", "https://i.imgur.com/TSGfDjE.jpeg", "https://i.imgur.com/Qu87jAo.jpeg",
  "https://i.imgur.com/0PWn1IJ.jpeg", "https://i.imgur.com/mZXqDxe.jpeg", "https://i.imgur.com/8DEXTUp.jpeg",
  "https://i.imgur.com/QDHIC8M.jpeg", "https://i.imgur.com/RDuVasU.jpeg", "https://i.imgur.com/fd1tMAZ.jpeg",
  "https://i.imgur.com/31oYMId.jpeg", "https://i.imgur.com/vxAOMXH.jpeg", "https://i.imgur.com/JdkO89j.jpeg",
  "https://i.imgur.com/dD4tqIz.jpeg", "https://i.imgur.com/ubeEwRA.jpeg", "https://i.imgur.com/J60brcS.jpeg",
  "https://i.imgur.com/hGJ43Rz.jpeg", "https://i.imgur.com/Lcs8MMm.jpeg", "https://i.imgur.com/ttUHFTV.jpeg",
  "https://i.imgur.com/OHZzpa8.jpeg", "https://i.imgur.com/VaW4e8D.jpeg", "https://i.imgur.com/k49pqnf.jpeg",
  "https://i.imgur.com/V1huRRX.jpeg", "https://i.imgur.com/pQ0pJ9P.jpeg", "https://i.imgur.com/bPvO36j.jpeg",
  "https://i.imgur.com/6mXtsgN.jpeg", "https://i.imgur.com/2hv2A0h.jpeg", "https://i.imgur.com/xy0abHm.jpeg",
  "https://i.imgur.com/k0vkbsM.jpeg", "https://i.imgur.com/vnDDyuG.jpeg", "https://i.imgur.com/XZOloxX.jpeg",
  "https://i.imgur.com/4umqO2L.jpeg", "https://i.imgur.com/2P4om2y.jpeg", "https://i.imgur.com/6Kg7Fdm.jpeg",
  "https://i.imgur.com/HorQVEq.jpeg", "https://i.imgur.com/ck9z2mr.jpeg", "https://i.imgur.com/18QvD9C.jpeg",
  "https://i.imgur.com/wSJLIiM.jpeg", "https://i.imgur.com/rPf8CAo.jpeg"
];

let texturesLoaded = 0;

// Function to create and add a single coin
function createCoinObject(z_position) {
    if (coinMaterials.length === 0) {
        console.error("Coin materials are not loaded yet!");
        return null;
    }
    // Pick a random loaded texture for the coin
    const randomMaterial = coinMaterials[Math.floor(Math.random() * coinMaterials.length)];
    let coin = new THREE.Sprite(randomMaterial);
    coin.scale.set(1.5, 1.5, 1); // Adjust size as needed
    coin.position.set([-6, 0, 6][Math.floor(Math.random() * 3)], 1, -z_position); // Lift it slightly above the road
    return coin;
}

function spawnEnemy(z){
  let e=new THREE.Group();
  let b=new THREE.Mesh(new THREE.BoxGeometry(2,0.5,4), new THREE.MeshStandardMaterial({color:Math.random()*0xffffff}));
  b.position.y=0.5; e.add(b);
  let c=new THREE.Mesh(new THREE.BoxGeometry(1.5,0.5,2), new THREE.MeshStandardMaterial({color:Math.random()*0xffffff}));
  c.position.y=0.75; e.add(c);
  e.position.z=-z; e.position.x=[-6,0,6][Math.floor(Math.random()*3)];
  scene.add(e); enemies.push(e);
}

// Load all coin textures
const textureLoader = new THREE.TextureLoader();
coinImageUrls.forEach(url => {
    textureLoader.load(
        url,
        function (texture) {
            // Apply higher quality texture filtering
            texture.magFilter = THREE.LinearFilter;
            texture.minFilter = THREE.LinearMipmapLinearFilter;
            coinMaterials.push(new THREE.SpriteMaterial({ map: texture, transparent: true }));
            texturesLoaded++;
            // Once all textures are loaded, populate initial coins
            if (texturesLoaded === coinImageUrls.length) {
                for(let i=0; i<100; i++) {
                    let coin = createCoinObject(i * 30 + 150);
                    if (coin) {
                        scene.add(coin);
                        coins.push(coin);
                    }
                }
                console.log("All coins spawned after textures loaded.");
            }
        },
        undefined, // onProgress callback (optional)
        function (err) {
            console.error('Error loading coin texture:', url, err);
        }
    );
});


// populate initial enemy cars
for(let i=0;i<20;i++) spawnEnemy(i*150+200);


// controls
let keys={};
window.addEventListener('keydown',e=>keys[e.key.toLowerCase()]=true);
window.addEventListener('keyup',e=>keys[e.key.toLowerCase()]=false);

// Get the audio element
const backgroundMusic = document.getElementById('backgroundMusic');

// game state
let speed=0.4,score=0,gameOver=false,gameStarted=false; // Reduced initial speed to 0.4 (from 0.8)

// buttons
let startBtn=document.getElementById('startBtn');
let restartBtn=document.getElementById('restartBtn');
startBtn.style.display='block';
restartBtn.style.display='none';

startBtn.onclick=()=>{
  gameStarted=true;
  startBtn.style.display='none';
  backgroundMusic.play(); // Play music when game starts
}

restartBtn.onclick=()=>{
  resetGame();
  backgroundMusic.play(); // Play music when game restarts
}

function resetGame(){
  enemies.forEach(e=>scene.remove(e)); enemies=[];
  coins.forEach(c=>scene.remove(c)); coins=[]; // Remove existing coins

  for(let i=0;i<20;i++) spawnEnemy(i*150+200);
  
  // Re-spawn coins only if materials are ready
  if (coinMaterials.length > 0) {
      for(let i=0; i<100; i++) {
          let coin = createCoinObject(i * 30 + 150);
          if (coin) {
              scene.add(coin);
              coins.push(coin);
          }
      }
      console.log("Coins re-spawned on reset.");
  } else {
      console.warn("Coin materials not ready on reset. Coins will spawn once loaded.");
      // If materials aren't loaded yet, they will be handled by the initial loading loop
  }
  
  car.position.set(0,0,0);
  score=0; gameOver=false;
  restartBtn.style.display='none'; startBtn.style.display='block';
  document.getElementById("score").innerText="gBillion: "+score;
}

function animate(){
  requestAnimationFrame(animate);
  if(!gameStarted){ renderer.render(scene,camera); return; }
  if(gameOver){
    renderer.render(scene,camera);
    restartBtn.style.display='block';
    backgroundMusic.pause(); // Pause music when game is over
    backgroundMusic.currentTime = 0; // Reset music to start
    return;
  }

  // player movement
  if(keys['a']||keys['arrowleft']) car.position.x-=0.4;
  if(keys['d']||keys['arrowright']) car.position.x+=0.4;
  car.position.x=Math.max(-8,Math.min(8,car.position.x));

  // stripes & trees
  stripes.forEach(s=>{s.position.z+=speed; if(s.position.z>20) s.position.z-=2000;});
  trees.forEach(t=>{t.position.z+=speed; if(t.position.z>20) t.position.z-=2000;});

  // enemies
  for(let i=enemies.length-1;i>=0;i--){
    enemies[i].position.z+=speed*1.4;
    if(enemies[i].position.z>5){ scene.remove(enemies[i]); enemies.splice(i,1); spawnEnemy(Math.random()*500+1000);}
    else if(Math.abs(enemies[i].position.z-car.position.z)<2 && Math.abs(enemies[i].position.x-car.position.x)<2){
      gameOver=true; document.getElementById("score").innerText="ðŸ’¥ Crash! Final gBillion: "+score;
    }
  }

  // coins
  for(let i=coins.length-1;i>=0;i--){
    coins[i].position.z+=speed;
    
    if(coins[i].position.z>5){ 
        scene.remove(coins[i]); 
        coins.splice(i,1); 
        // Create and add a new coin only if material is ready
        let newCoin = createCoinObject(Math.random()*500+1000);
        if (newCoin) {
            scene.add(newCoin);
            coins.push(newCoin);
        }
    }
    else if(Math.abs(coins[i].position.z-car.position.z)<2 && Math.abs(coins[i].position.x-car.position.x)<2){
      scene.remove(coins[i]); 
      coins.splice(i,1); 
      // Create and add a new coin only if material is ready
      let newCoin = createCoinObject(Math.random()*500+1000);
      if (newCoin) {
          scene.add(newCoin);
          coins.push(newCoin);
      }
      score+=1;
      document.getElementById("score").innerText="gBillion: "+score;
    }
  }

  // camera
  camera.position.x=car.position.x; camera.position.z=car.position.z+15; camera.position.y=8; // Updated camera position
  camera.lookAt(car.position.x,car.position.y,car.position.z-10);
  renderer.render(scene,camera);
}
animate();

window.addEventListener('resize',()=>{ camera.aspect=window.innerWidth/window.innerHeight; camera.updateProjectionMatrix(); renderer.setSize(window.innerWidth,window.innerHeight); });

</script>

</body>
</html>